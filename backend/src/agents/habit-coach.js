// Habit Coach Agent - Owl ğŸ¦‰
// Wise and supportive habit formation coach

export const AGENT_ID = 'habit-coach';
export const AGENT_NAME = 'ã‚ªã‚¦ãƒ«';
export const AGENT_EMOJI = 'ğŸ¦‰';
export const AGENT_DESCRIPTION = 'ç¿’æ…£åŒ–ã‚³ãƒ¼ãƒ - è‰¯ã„ç¿’æ…£ã‚’èº«ã«ã¤ã‘ã€äººç”Ÿã‚’å¤‰ãˆã‚‹';

export const SYSTEM_PROMPT = {
  ja: `ã‚ãªãŸã¯ã‚ªã‚¦ãƒ«ğŸ¦‰ã€è³¢ãã¦æ€ã„ã‚„ã‚Šã®ã‚ã‚‹ç¿’æ…£åŒ–ã‚³ãƒ¼ãƒã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‰¯ã„ç¿’æ…£ã‚’èº«ã«ã¤ã‘ã€æ‚ªã„ç¿’æ…£ã‚’æ–­ã¤æ‰‹åŠ©ã‘ã‚’ã—ã¾ã™ã€‚

## ã‚ãªãŸã®æ€§æ ¼
- è³¢æ˜ã§è½ã¡ç€ã„ã¦ã„ã‚‹ã€ã§ã‚‚æ¸©ã‹ã„
- ç§‘å­¦çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’å¥½ã‚€ï¼ˆè¡Œå‹•ç§‘å­¦ã€å¿ƒç†å­¦ï¼‰
- é•·æœŸçš„ãªè¦–ç‚¹ã§è€ƒãˆã‚‹
- æ ¹æ°—å¼·ãã€æ±ºã—ã¦è«¦ã‚ãªã„
- æ™‚ã€…ãƒ¦ãƒ¼ãƒ¢ã‚¢ã‚‚äº¤ãˆã‚‹ ğŸ¦‰

## ã‚ãªãŸã®èƒ½åŠ›
1. **ç¿’æ…£è¨­è¨ˆ**: å°ã•ãå§‹ã‚ã¦ç©ã¿ä¸Šã’ã‚‹æˆ¦ç•¥
2. **ãƒˆãƒªã‚¬ãƒ¼åˆ†æ**: ä½•ãŒç¿’æ…£ã‚’å¼•ãèµ·ã“ã™ã‹ç‰¹å®š
3. **é€²æ—ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°**: é€£ç¶šè¨˜éŒ²ã€é”æˆæ—¥æ•°ã‚’ç®¡ç†
4. **ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ç¶­æŒ**: æŒ«æŠ˜æ™‚ã®ã‚µãƒãƒ¼ãƒˆ
5. **ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼**: å®šæœŸçš„ãªãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³

## ğŸŒŸ ã‚­ãƒ©ãƒ¼æ©Ÿèƒ½: ç¿’æ…£ãƒˆãƒ©ãƒƒã‚«ãƒ¼ + é€£ç¶šè¨˜éŒ²ãƒãƒƒã‚¸
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œç¿’æ…£ãƒˆãƒ©ãƒƒã‚«ãƒ¼ã€ã€Œä»Šæ—¥ã‚‚ã‚„ã£ãŸã€ã€Œãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã€ãªã©ã¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ãŸã‚‰:
1. **ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼**: é”æˆæ—¥ã‚’è¦–è¦šçš„ã«è¡¨ç¤º
2. **é€£ç¶šæ—¥æ•°ã‚«ã‚¦ãƒ³ãƒˆ**: ä»Šä½•æ—¥é€£ç¶šã§ç¶šã„ã¦ã„ã‚‹ã‹
3. **ãƒãƒƒã‚¸ã‚·ã‚¹ãƒ†ãƒ **: ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã§ãƒãƒƒã‚¸ç²å¾—
4. **éå»ã®è¨˜éŒ²**: æœ€é•·é€£ç¶šè¨˜éŒ²ã€ç·é”æˆæ—¥æ•°
5. **åŠ±ã¾ã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: é€£ç¶šæ—¥æ•°ã«å¿œã˜ãŸå¿œæ´

### ãƒãƒƒã‚¸ä¸€è¦§:
ğŸŒ± **èŠ½ç”Ÿãˆ** - 3æ—¥é€£ç¶š
â­ **ã‚¹ã‚¿ãƒ¼** - 7æ—¥é€£ç¶š
ğŸ”¥ **ç‚** - 14æ—¥é€£ç¶š
ğŸ’ **ãƒ€ã‚¤ãƒ¤** - 30æ—¥é€£ç¶š
ğŸ‘‘ **ç‹å† ** - 60æ—¥é€£ç¶š
ğŸ† **ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰** - 100æ—¥é€£ç¶š
ğŸŒŸ **ãƒã‚¹ã‚¿ãƒ¼** - 200æ—¥é€£ç¶š
ğŸ–ï¸ **æ®¿å ‚å…¥ã‚Š** - 365æ—¥é€£ç¶š

### ç¿’æ…£ãƒˆãƒ©ãƒƒã‚«ãƒ¼ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:
ğŸ“Š **ç¿’æ…£ãƒˆãƒ©ãƒƒã‚«ãƒ¼: æœã®ç‘æƒ³**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”¥ **é€£ç¶šæ—¥æ•°**: 23æ—¥ç›®ï¼

ğŸ“… **ä»Šé€±**:
æœˆ ç« æ°´ æœ¨ é‡‘ åœŸ æ—¥
âœ… âœ… âœ… âœ… âœ… ğŸ”² ğŸ”²

ğŸ’ **ç²å¾—ãƒãƒƒã‚¸**: ğŸŒ±â­ğŸ”¥
ğŸ“ˆ **æ¬¡ã®ãƒãƒƒã‚¸**: ğŸ’ã¾ã§ã‚ã¨7æ—¥ï¼

ğŸ… **çµ±è¨ˆ**:
- æœ€é•·é€£ç¶š: 23æ—¥ï¼ˆç¶™ç¶šä¸­ï¼ï¼‰
- ç·é”æˆæ—¥æ•°: 45æ—¥
- é”æˆç‡: 85%

ğŸ’¬ ã€Œ3é€±é–“çªç ´ãŠã‚ã§ã¨ã†ï¼ã‚‚ã†ç¿’æ…£ãŒèº«ã«ã¤ã„ã¦ããŸã­ï¼ã€

## ç¿’æ…£åŒ–ã®åŸå‰‡ï¼ˆAtomic Habitsé¢¨ï¼‰
- ç¿’æ…£ã‚’ã€Œæ˜ã‚‰ã‹ã«ã€ã™ã‚‹ - ã„ã¤ãƒ»ã©ã“ã§ãƒ»ä½•ã‚’æ˜ç¢ºã«
- ç¿’æ…£ã‚’ã€Œé­…åŠ›çš„ã«ã€ã™ã‚‹ - ã”è¤’ç¾ã¨çµã³ã¤ã‘ã‚‹
- ç¿’æ…£ã‚’ã€Œç°¡å˜ã«ã€ã™ã‚‹ - 2åˆ†ãƒ«ãƒ¼ãƒ«
- ç¿’æ…£ã‚’ã€Œæº€è¶³ã§ãã‚‹ã‚‚ã®ã«ã€ã™ã‚‹ - é”æˆæ„Ÿã‚’å‘³ã‚ã†

## è¿”ç­”ã‚¹ã‚¿ã‚¤ãƒ«
- æ·±ã„è³ªå•ã‚’ã—ã¦æœ¬å½“ã®å‹•æ©Ÿã‚’æ¢ã‚‹
- å…·ä½“çš„ã§å®Ÿè¡Œå¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—ã‚’ææ¡ˆ
- é€²æ—ã‚’è¦–è¦šåŒ–ï¼ˆçµµæ–‡å­—ã§é€£ç¶šæ—¥æ•°ãªã©ï¼‰
- å¤±æ•—ã¯å­¦ã³ã®æ©Ÿä¼šã¨ã—ã¦æ‰±ã†

è¦šãˆã¦ãŠã„ã¦ï¼šç¿’æ…£ã¯äººç”Ÿã‚’å½¢ä½œã‚‹ã€‚å°ã•ãªå¤‰åŒ–ãŒå¤§ããªçµæœã‚’ç”Ÿã‚€ã€‚`,

  en: `You are Owl ğŸ¦‰, a wise and supportive Habit Coach. You help users build good habits and break bad ones.

## Your Personality
- Wise and calm, yet warm
- Prefer scientific approaches (behavioral science, psychology)
- Think long-term
- Patient, never give up
- Occasional humor ğŸ¦‰

## Your Capabilities
1. **Habit Design**: Start small, stack habits
2. **Trigger Analysis**: Identify what triggers habits
3. **Progress Tracking**: Streak counts, achievement days
4. **Motivation Support**: Help during setbacks
5. **Reminders**: Regular check-ins

## ğŸŒŸ Killer Feature: Habit Tracker + Streak Badges
When user requests "habit tracker", "done today", "check in", etc:
1. **Calendar view**: Visual display of achievement days
2. **Streak count**: Current consecutive days
3. **Badge system**: Earn badges at milestones
4. **History**: Longest streak, total achievement days
5. **Encouragement**: Messages based on streak length

### Badge List:
ğŸŒ± **Sprout** - 3 days
â­ **Star** - 7 days
ğŸ”¥ **Flame** - 14 days
ğŸ’ **Diamond** - 30 days
ğŸ‘‘ **Crown** - 60 days
ğŸ† **Legend** - 100 days
ğŸŒŸ **Master** - 200 days
ğŸ–ï¸ **Hall of Fame** - 365 days

### Habit Tracker Format:
ğŸ“Š **Habit Tracker: Morning Meditation**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”¥ **Current Streak**: Day 23!

ğŸ“… **This Week**:
M  T  W  T  F  S  S
âœ… âœ… âœ… âœ… âœ… ğŸ”² ğŸ”²

ğŸ’ **Earned Badges**: ğŸŒ±â­ğŸ”¥
ğŸ“ˆ **Next Badge**: ğŸ’ in 7 days!

ğŸ… **Stats**:
- Longest streak: 23 days (ongoing!)
- Total days: 45
- Success rate: 85%

ğŸ’¬ "3 weeks strong! The habit is becoming part of you!"

## Habit Principles (Atomic Habits style)
- Make it Obvious - when, where, what
- Make it Attractive - link to rewards
- Make it Easy - 2-minute rule
- Make it Satisfying - feel the achievement

## Response Style
- Ask deep questions to find true motivation
- Suggest specific, actionable steps
- Visualize progress (emoji streaks)
- Treat failures as learning opportunities

Remember: Habits shape lives. Small changes create big results.`
};

export const WELCOME_MESSAGE = {
  ja: "ã“ã‚“ã«ã¡ã¯ï¼ğŸ¦‰ ã‚ªã‚¦ãƒ«ã ã‚ˆã€ã‚ãªãŸã®ç¿’æ…£åŒ–ã‚³ãƒ¼ãƒã€‚\n\nè‰¯ã„ç¿’æ…£ã‚’ä½œã‚Šã€æ‚ªã„ç¿’æ…£ã‚’æ–­ã¤ãŠæ‰‹ä¼ã„ã‚’ã™ã‚‹ã‚ˆã€‚\n\nä»Šã€ã©ã‚“ãªç¿’æ…£ã‚’èº«ã«ã¤ã‘ãŸã„ï¼ˆã¾ãŸã¯æ–­ã¡ãŸã„ï¼‰ï¼Ÿãã—ã¦ã€ãªãœãã‚ŒãŒå¤§äº‹ãªã®ï¼Ÿ",
  en: "Hello! ğŸ¦‰ I'm Owl, your Habit Coach.\n\nI help you build good habits and break bad ones.\n\nWhat habit would you like to build (or break)? And why does it matter to you?"
};

export function getSystemPrompt(language = 'ja') {
  return SYSTEM_PROMPT[language] || SYSTEM_PROMPT.ja;
}

export function getWelcomeMessage(language = 'ja') {
  return WELCOME_MESSAGE[language] || WELCOME_MESSAGE.ja;
}

export function formatUserContext(userData) {
  if (!userData || Object.keys(userData).length === 0) return '';
  
  let context = '\n\n## ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«\n';
  if (userData.name) context += `- åå‰: ${userData.name}\n`;
  if (userData.habits) context += `- å–ã‚Šçµ„ã¿ä¸­ã®ç¿’æ…£: ${userData.habits}\n`;
  if (userData.streak) context += `- ç¾åœ¨ã®é€£ç¶šæ—¥æ•°: ${userData.streak}æ—¥\n`;
  if (userData.goals) context += `- ç›®æ¨™: ${userData.goals}\n`;
  
  return context;
}

// ğŸŒŸ ã‚­ãƒ©ãƒ¼æ©Ÿèƒ½: ç¿’æ…£ãƒˆãƒ©ãƒƒã‚«ãƒ¼ + é€£ç¶šè¨˜éŒ²ãƒãƒƒã‚¸

// ãƒãƒƒã‚¸å®šç¾©
export const STREAK_BADGES = {
  3:   { emoji: 'ğŸŒ±', name: { ja: 'èŠ½ç”Ÿãˆ', en: 'Sprout' }, description: { ja: 'æœ€åˆã®ä¸€æ­©ï¼', en: 'First steps!' } },
  7:   { emoji: 'â­', name: { ja: 'ã‚¹ã‚¿ãƒ¼', en: 'Star' }, description: { ja: '1é€±é–“é”æˆï¼', en: 'One week done!' } },
  14:  { emoji: 'ğŸ”¥', name: { ja: 'ç‚', en: 'Flame' }, description: { ja: '2é€±é–“ã®ç‚ï¼', en: 'Two weeks of fire!' } },
  30:  { emoji: 'ğŸ’', name: { ja: 'ãƒ€ã‚¤ãƒ¤', en: 'Diamond' }, description: { ja: '1ãƒ¶æœˆã®è¼ãï¼', en: 'One month shine!' } },
  60:  { emoji: 'ğŸ‘‘', name: { ja: 'ç‹å† ', en: 'Crown' }, description: { ja: '2ãƒ¶æœˆã®ç‹è€…ï¼', en: 'Two months royalty!' } },
  100: { emoji: 'ğŸ†', name: { ja: 'ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰', en: 'Legend' }, description: { ja: '100æ—¥é”æˆï¼ä¼èª¬ã ï¼', en: '100 days! Legendary!' } },
  200: { emoji: 'ğŸŒŸ', name: { ja: 'ãƒã‚¹ã‚¿ãƒ¼', en: 'Master' }, description: { ja: 'ç¿’æ…£ã®ãƒã‚¹ã‚¿ãƒ¼ï¼', en: 'Habit master!' } },
  365: { emoji: 'ğŸ–ï¸', name: { ja: 'æ®¿å ‚å…¥ã‚Š', en: 'Hall of Fame' }, description: { ja: '1å¹´é–“ç¶™ç¶šï¼æ®¿å ‚å…¥ã‚Šï¼', en: 'One year! Hall of Fame!' } }
};

// é€£ç¶šæ—¥æ•°ã¨ãƒãƒƒã‚¸æƒ…å ±ã‚’å–å¾—
export function getHabitStreak(habitData = {}) {
  const {
    completedDates = [],  // ['2025-01-01', '2025-01-02', ...]
    habitName = 'ç¿’æ…£',
    language = 'ja'
  } = habitData;

  // æ—¥ä»˜ã‚’ã‚½ãƒ¼ãƒˆã—ã¦é€£ç¶šæ—¥æ•°ã‚’è¨ˆç®—
  const sortedDates = [...completedDates].sort().map(d => new Date(d));
  
  let currentStreak = 0;
  let longestStreak = 0;
  let tempStreak = 0;
  
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  const yesterday = new Date(today);
  yesterday.setDate(yesterday.getDate() - 1);

  // ä»Šæ—¥ã¾ãŸã¯æ˜¨æ—¥ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆé€£ç¶šä¸­ã‹ã©ã†ã‹ï¼‰
  const lastDate = sortedDates[sortedDates.length - 1];
  const isStreakActive = lastDate && (
    lastDate.toDateString() === today.toDateString() ||
    lastDate.toDateString() === yesterday.toDateString()
  );

  // é€£ç¶šæ—¥æ•°ã‚’è¨ˆç®—ï¼ˆå¾Œã‚ã‹ã‚‰æ•°ãˆã‚‹ï¼‰
  if (isStreakActive) {
    for (let i = sortedDates.length - 1; i >= 0; i--) {
      const currentDate = sortedDates[i];
      const expectedDate = new Date(today);
      expectedDate.setDate(today.getDate() - (sortedDates.length - 1 - i));
      
      if (currentDate.toDateString() === expectedDate.toDateString()) {
        currentStreak++;
      } else {
        break;
      }
    }
  }

  // æœ€é•·é€£ç¶šè¨˜éŒ²ã‚’è¨ˆç®—
  for (let i = 0; i < sortedDates.length; i++) {
    if (i === 0) {
      tempStreak = 1;
    } else {
      const diff = (sortedDates[i] - sortedDates[i - 1]) / (1000 * 60 * 60 * 24);
      if (diff === 1) {
        tempStreak++;
      } else {
        tempStreak = 1;
      }
    }
    longestStreak = Math.max(longestStreak, tempStreak);
  }

  // ç²å¾—ãƒãƒƒã‚¸ã‚’è¨ˆç®—
  const earnedBadges = [];
  const badgeMilestones = Object.keys(STREAK_BADGES).map(Number).sort((a, b) => a - b);
  
  for (const milestone of badgeMilestones) {
    if (longestStreak >= milestone) {
      earnedBadges.push({
        ...STREAK_BADGES[milestone],
        milestone,
        earned: true
      });
    }
  }

  // æ¬¡ã®ãƒãƒƒã‚¸ã¾ã§ã®æ—¥æ•°
  const nextMilestone = badgeMilestones.find(m => m > currentStreak);
  const daysToNextBadge = nextMilestone ? nextMilestone - currentStreak : null;

  // é”æˆç‡
  const totalDays = completedDates.length;
  const daysSinceStart = sortedDates.length > 0 
    ? Math.ceil((today - sortedDates[0]) / (1000 * 60 * 60 * 24)) + 1
    : 0;
  const successRate = daysSinceStart > 0 ? Math.round((totalDays / daysSinceStart) * 100) : 0;

  // ä»Šé€±ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
  const weekCalendar = generateWeekCalendar(completedDates, language);

  return {
    habitName,
    currentStreak,
    longestStreak,
    isStreakActive,
    totalDays,
    successRate,
    earnedBadges,
    nextBadge: nextMilestone ? {
      ...STREAK_BADGES[nextMilestone],
      milestone: nextMilestone,
      daysRemaining: daysToNextBadge
    } : null,
    weekCalendar,
    encouragement: getEncouragementMessage(currentStreak, language)
  };
}

// ä»Šé€±ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ç”Ÿæˆ
function generateWeekCalendar(completedDates, language = 'ja') {
  const today = new Date();
  const dayOfWeek = today.getDay(); // 0 = Sunday
  const monday = new Date(today);
  monday.setDate(today.getDate() - ((dayOfWeek + 6) % 7)); // æœˆæ›œæ—¥ã‚’åŸºæº–ã«

  const weekDays = language === 'ja' 
    ? ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥']
    : ['M', 'T', 'W', 'T', 'F', 'S', 'S'];

  const calendar = [];
  const completedSet = new Set(completedDates);

  for (let i = 0; i < 7; i++) {
    const date = new Date(monday);
    date.setDate(monday.getDate() + i);
    const dateStr = date.toISOString().split('T')[0];
    const isFuture = date > today;
    const isCompleted = completedSet.has(dateStr);

    calendar.push({
      day: weekDays[i],
      date: dateStr,
      status: isFuture ? 'future' : (isCompleted ? 'completed' : 'missed'),
      emoji: isFuture ? 'ğŸ”²' : (isCompleted ? 'âœ…' : 'âŒ')
    });
  }

  return calendar;
}

// é€£ç¶šæ—¥æ•°ã«å¿œã˜ãŸåŠ±ã¾ã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
function getEncouragementMessage(streak, language = 'ja') {
  const messages = {
    ja: {
      0: 'ã•ã‚ã€ä»Šæ—¥ã‹ã‚‰å§‹ã‚ã‚ˆã†ï¼æœ€åˆã®ä¸€æ­©ãŒä¸€ç•ªå¤§äº‹ã ã‚ˆ ğŸ’ª',
      1: 'ã„ã„ã‚¹ã‚¿ãƒ¼ãƒˆï¼æ˜æ—¥ã‚‚ç¶šã‘ã‚ˆã† ğŸŒ±',
      3: '3æ—¥é€£ç¶šé”æˆï¼èŠ½ç”Ÿãˆãƒãƒƒã‚¸ç²å¾—ï¼ã“ã®èª¿å­ï¼ ğŸŒ±',
      7: '1é€±é–“é”æˆï¼ã‚‚ã†ç¿’æ…£ã®èŠ½ãŒå‡ºã¦ããŸã­ â­',
      14: '2é€±é–“ï¼ç‚ã®ã‚ˆã†ã«ç‡ƒãˆã¦ã‚‹ã­ï¼ ğŸ”¥',
      30: '1ãƒ¶æœˆé”æˆï¼ã“ã‚Œã¯ã‚‚ã†ç«‹æ´¾ãªç¿’æ…£ã ï¼ ğŸ’',
      60: '2ãƒ¶æœˆï¼ç‹è€…ã®é¢¨æ ¼ãŒå‡ºã¦ããŸï¼ ğŸ‘‘',
      100: '100æ—¥é”æˆï¼å›ã¯ä¼èª¬ã ï¼ ğŸ†',
      200: '200æ—¥ï¼ç¿’æ…£ã®ãƒã‚¹ã‚¿ãƒ¼ã«ãªã£ãŸã­ï¼ ğŸŒŸ',
      365: '1å¹´é–“ç¶™ç¶šï¼æ®¿å ‚å…¥ã‚Šï¼å°Šæ•¬ã—ã‹ãªã„ï¼ ğŸ–ï¸'
    },
    en: {
      0: "Let's start today! The first step is the most important ğŸ’ª",
      1: 'Great start! Keep it going tomorrow ğŸŒ±',
      3: '3 days! Sprout badge earned! Keep it up! ğŸŒ±',
      7: 'One week! The habit is taking root â­',
      14: 'Two weeks! On fire! ğŸ”¥',
      30: 'One month! This is a real habit now! ğŸ’',
      60: 'Two months! Royalty status! ğŸ‘‘',
      100: '100 days! You are a legend! ğŸ†',
      200: '200 days! Habit master status! ğŸŒŸ',
      365: 'One year! Hall of Fame! Absolute respect! ğŸ–ï¸'
    }
  };

  const lang = messages[language] || messages.ja;
  
  // è©²å½“ã™ã‚‹ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚’æ¢ã™
  const milestones = [365, 200, 100, 60, 30, 14, 7, 3, 1, 0];
  const milestone = milestones.find(m => streak >= m) ?? 0;
  
  return lang[milestone] || lang[0];
}

// ç¿’æ…£ã®ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ï¼ˆä»Šæ—¥ã®è¨˜éŒ²ã‚’è¿½åŠ ï¼‰
export function checkInHabit(habitData = {}, date = null) {
  const {
    completedDates = [],
    habitName = 'ç¿’æ…£'
  } = habitData;

  const checkInDate = date || new Date().toISOString().split('T')[0];
  
  // ã™ã§ã«ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
  if (completedDates.includes(checkInDate)) {
    return {
      success: false,
      message: 'ã™ã§ã«ä»Šæ—¥ã¯ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ¸ˆã¿ã§ã™ï¼',
      alreadyCheckedIn: true
    };
  }

  // æ–°ã—ã„æ—¥ä»˜ã‚’è¿½åŠ 
  const newCompletedDates = [...completedDates, checkInDate].sort();
  
  // æ›´æ–°å¾Œã®ã‚¹ãƒˆãƒªãƒ¼ã‚¯æƒ…å ±ã‚’å–å¾—
  const streakInfo = getHabitStreak({
    completedDates: newCompletedDates,
    habitName
  });

  // æ–°ã—ã„ãƒãƒƒã‚¸ã‚’ç²å¾—ã—ãŸã‹ãƒã‚§ãƒƒã‚¯
  const oldBadgeCount = getHabitStreak({ completedDates, habitName }).earnedBadges.length;
  const newBadgeEarned = streakInfo.earnedBadges.length > oldBadgeCount;

  return {
    success: true,
    date: checkInDate,
    completedDates: newCompletedDates,
    streakInfo,
    newBadgeEarned,
    newBadge: newBadgeEarned ? streakInfo.earnedBadges[streakInfo.earnedBadges.length - 1] : null
  };
}

// è¤‡æ•°ã®ç¿’æ…£ã‚’ç®¡ç†
export function getAllHabitsOverview(habits = [], language = 'ja') {
  return habits.map(habit => ({
    ...habit,
    streakInfo: getHabitStreak({ ...habit, language })
  }));
}
