name: Build Android

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          
      - name: Install dependencies
        run: npm install
        
      - name: Prebuild Android
        run: npx expo prebuild --platform android --clean

      - name: Create Keystore
        run: |
          cd android/app
          keytool -genkeypair -v -storetype PKCS12 \
            -keystore release.keystore \
            -alias release \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass android \
            -keypass android \
            -dname "CN=DoDo, OU=DoDo, O=DoDo, L=Tokyo, ST=Tokyo, C=JP"
          
      - name: Configure signing in build.gradle
        run: |
          cd android/app
          
          # Add signing config to build.gradle
          cat > signing.gradle << 'SIGNEOF'
          android {
              signingConfigs {
                  release {
                      storeFile file('release.keystore')
                      storePassword 'android'
                      keyAlias 'release'
                      keyPassword 'android'
                  }
              }
              buildTypes {
                  release {
                      signingConfig signingConfigs.release
                  }
              }
          }
          SIGNEOF
          
          # Apply signing config
          echo "apply from: 'signing.gradle'" >> build.gradle
          
      - name: Set Gradle memory
        run: |
          echo "org.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=1024m" >> android/gradle.properties
        
      - name: Build Release APK
        run: |
          cd android
          ./gradlew assembleRelease --no-daemon --max-workers=2
        env:
          GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=1024m"

      - name: Build Release AAB
        run: |
          cd android
          ./gradlew bundleRelease --no-daemon --max-workers=2
        env:
          GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=1024m"
          
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: dodo-release-apk
          path: android/app/build/outputs/apk/release/*.apk

      - name: Upload AAB
        uses: actions/upload-artifact@v4
        with:
          name: dodo-release-aab
          path: android/app/build/outputs/bundle/release/*.aab
          
      - name: Backup Keystore
        run: |
          base64 android/app/release.keystore > keystore-backup.txt
          
      - name: Upload Keystore Backup
        uses: actions/upload-artifact@v4
        with:
          name: keystore-backup
          path: keystore-backup.txt
